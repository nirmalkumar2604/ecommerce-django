{% extends "e-com/base.html" %}
{% block title %}My Cart | NK Mart{% endblock %}

{% block content %}
<div class="cart-container">
  <h2 class="section-title">ðŸ›’ My Shopping Cart</h2>
  <div id="cartItems" class="cart-items"></div>
  <div id="cartSummary" class="cart-summary hidden">
    <p class="total-label">Total:</p>
    <p class="total-price" id="totalPrice">â‚¹0</p>
    <button id="checkoutBtn">Proceed to Checkout</button>
  </div>
</div>

<script>
async function loadCart() {
  const email = prompt("Enter your registered email:");
  if (!email) return alert("âŒ Email required to view your cart.");

  const res = await fetch(`/api/view_cart/?email=${email}`);
  const data = await res.json();

  const cartItems = document.getElementById("cartItems");
  const summary = document.getElementById("cartSummary");
  const totalPriceEl = document.getElementById("totalPrice");

  cartItems.innerHTML = "";
  summary.classList.add("hidden");

  if (res.ok && data.cart && data.cart.length > 0) {
    let total = 0;
    data.cart.forEach((item) => {
      total += item.product.price * item.quantity;

      const div = document.createElement("div");
      div.classList.add("cart-item");
      div.innerHTML = `
        <img src="${item.product.image || 'https://via.placeholder.com/120'}" alt="${item.product.name}" />
        <div class="cart-details">
          <h3>${item.product.name}</h3>
          <p>${item.product.description}</p>
          <p>â‚¹${item.product.price} Ã— ${item.quantity}</p>
        </div>
        <button onclick="removeFromCart('${item.id}')">Remove</button>
      `;
      cartItems.appendChild(div);
    });

    totalPriceEl.textContent = "â‚¹" + total;
    summary.classList.remove("hidden");
  } else {
    cartItems.innerHTML = "<p class='no-products'>Your cart is empty.</p>";
  }
}

async function removeFromCart(cartId) {
  const res = await fetch("/api/remove_from_cart/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ cart_id: cartId }),
  });
  const data = await res.json();
  if (res.ok) {
    alert("âœ… Removed from cart!");
    loadCart();
  } else {
    alert("âŒ " + (data.error || "Failed to remove item"));
  }
}

document.getElementById("checkoutBtn").addEventListener("click", () => {
  alert("ðŸ§¾ Order placed successfully! (checkout coming soon)");
  window.location.href = "/ui/orders/";
});

loadCart();
</script>
{% endblock %}
